---
title: "readme"
author: "Andrew"
date: "8/18/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(tidyverse)
library(gdm)
```

# GDM use case example

# Introduction
# Methods
# Results

## Import the data
```{r}
source("data-prep.R")
```

## GDM
```{r}
library(gdm)
tbl_04
# table is an x-y species list (bioFormat = 2) where there is one row per species record rather than per site
```

```{r}
str(tbl_03)
sppTab_Bowra <- tbl_03[, c("common_name", "point_name", "lat", "lon")]
envTab_Bowra <- tbl_03[, c(3:ncol(tbl_03))]
envTab_Bowra <- envTab_Bowra %>% select(-c(treatment, site_code))
```

```{r}
# get site pair table
gdmTab <- formatsitepair(bioData=sppTab_Bowra, 
                         bioFormat=2, #x-y spp list
                         XColumn="lon", 
                         YColumn="lat",
                         sppColumn="common_name", 
                         siteColumn="point_name", 
                         predData=envTab_Bowra, verbose = TRUE)

# fit a gdm
gdm_01 <- gdm(data=gdmTab, geo = TRUE)
summary(gdm_01)
length(gdm_01$predictors) # get ideal of number of panels
plot(gdm_01, plot.layout=c(2,3))
```
# Practicing gdm with raster
In addition to starting with tablular data, environmental data can be extracted directly from rasters, assuming the x-y coordinates of sites are provided in either a site-species table (bioFormat=1) or as a x-y species list (bioFormat=2).

```{r}
# environmental raster data for sw oz
swBioclims <- raster::stack(system.file("./extdata/swBioclims.grd", package="gdm"))

gdmTab.rast <- formatsitepair(bioData=sppTab, 
                              bioFormat=2, # x-y spp list
                              XColumn="Long", 
                              YColumn="Lat", 
                              sppColumn="species",
                              siteColumn="site",
                              predData=swBioclims) #raster stack
```
Because some sites might not overlap with the rasters, we should check for and remove NA values from the site-pair table:

```{r}
sum(is.na(gdmTab.rast))
#> [1] 465
gdmTab.rast <- na.omit(gdmTab.rast)
```

Note that the formatsitepair function assumes that the coordinates of the sites are in the same coordinate system as the rasters. At present, no checking is performed to ensure this is the case. Note also that if your site coordinates are longitude-latitude that the calculation of geographic distances between sites will have errors, the size of which will depend on the geographic extent and location of your study region. We hope to deal with this in a later release, but for now you can avoid these problems by using a projected coordinate system (e.g., equidistant).


```{r}
# fit a new gdm using a table with climate data only (to match rasters)
gdm.rast <- gdm(gdmTab.rast, geo=T)
summary(gdm.rast)
# make some fake climate change data
futRasts <- swBioclims
##reduce winter precipitation by 25% & increase temps
futRasts[[3]] <- futRasts[[3]]*0.75
futRasts[[4]] <- futRasts[[4]]+2
futRasts[[5]] <- futRasts[[5]]+3
```

```{r}
library(colorRamps)
timePred <- predict(gdm.rast, swBioclims, time=T, predRasts=futRasts)
raster::plot(timePred, col=rgb.tables(1000))
#Predicted magnitude of biological change through time


```


# Discussion

